# AWS IoT EduKit LED点灯サンプルプログラム 仕様書

## 1. 概要

### 1.1 目的
本仕様書は、AWS IoT EduKitのRGB LEDを制御するサンプルプログラムの仕様を定義します。
本プログラムは、デバイスの基本的な動作確認とGPIO制御の学習を目的としています。

### 1.2 対象デバイス
- **製品名**: AWS IoT EduKit
- **マイコン**: ESP32-WROVER
- **開発フレームワーク**: ESP-IDF v4.4以降

### 1.3 作成日
2025年12月27日

---

## 2. システム構成

### 2.1 ハードウェア構成

| コンポーネント | 仕様 | 備考 |
|--------------|------|------|
| マイコン | ESP32-WROVER | デュアルコア, 240MHz |
| 赤色LED | GPIO4 | RGB LEDの赤色要素 |
| 緑色LED | GPIO5 | RGB LEDの緑色要素 |
| 青色LED | GPIO6 | RGB LEDの青色要素 |
| 電源 | USB Type-C | 5V供給 |

### 2.2 ソフトウェア構成

| モジュール | ファイル名 | 説明 |
|----------|-----------|------|
| メインプログラム | led_sample.c | LED制御のメイン処理 |
| ビルド設定 | CMakeLists.txt | プロジェクトのビルド設定 |
| コンポーネント設定 | main/CMakeLists.txt | メインコンポーネントの設定 |
| SDK設定 | sdkconfig.defaults | ESP-IDFのデフォルト設定 |

---

## 3. 機能仕様

### 3.1 機能一覧

| 機能ID | 機能名 | 説明 |
|-------|--------|------|
| F001 | LED初期化機能 | GPIO設定とLED初期状態の設定 |
| F002 | LED個別制御機能 | 指定したLEDのON/OFF制御 |
| F003 | RGB色設定機能 | RGB各色の組み合わせによる色設定 |
| F004 | LED点滅パターン制御 | 7色+消灯のパターン点滅 |

### 3.2 機能詳細

#### 3.2.1 F001: LED初期化機能

**関数名**: `led_init(void)`

**処理概要**:
1. GPIO設定構造体の初期化
2. 赤・緑・青LEDのGPIOピンを出力モードに設定
3. プルアップ/プルダウン抵抗を無効化
4. 割り込みを無効化
5. 全LEDを初期状態（OFF）に設定

**入力**: なし

**出力**: なし

**エラー処理**: GPIO設定エラー時はESP-IDFのエラーハンドラで処理

#### 3.2.2 F002: LED個別制御機能

**関数名**: `led_set(gpio_num_t gpio_num, uint8_t state)`

**処理概要**:
指定されたGPIOピンのLEDをON/OFFします。

**入力**:
- `gpio_num`: 制御対象のGPIO番号
- `state`: LED状態（1=ON, 0=OFF）

**出力**: なし

**制約事項**: GPIO番号は事前に出力モードに設定されている必要があります。

#### 3.2.3 F003: RGB色設定機能

**関数名**: `led_set_rgb(uint8_t red, uint8_t green, uint8_t blue)`

**処理概要**:
RGB 3色のLEDを同時に制御し、任意の色を表示します。

**入力**:
- `red`: 赤色LED状態（1=ON, 0=OFF）
- `green`: 緑色LED状態（1=ON, 0=OFF）
- `blue`: 青色LED状態（1=ON, 0=OFF）

**出力**: なし

**色パターン例**:

| R | G | B | 表示色 |
|---|---|---|--------|
| 1 | 0 | 0 | 赤 |
| 0 | 1 | 0 | 緑 |
| 0 | 0 | 1 | 青 |
| 1 | 1 | 0 | 黄 |
| 1 | 0 | 1 | マゼンタ |
| 0 | 1 | 1 | シアン |
| 1 | 1 | 1 | 白 |
| 0 | 0 | 0 | 消灯 |

#### 3.2.4 F004: LED点滅パターン制御

**関数名**: `led_blink_task(void *pvParameter)`

**処理概要**:
FreeRTOSタスクとして動作し、以下のパターンを1秒間隔で繰り返します。

**点滅シーケンス**:

| ステップ | 色 | R | G | B | 継続時間 |
|---------|-----|---|---|---|---------|
| 1 | 赤 | 1 | 0 | 0 | 1秒 |
| 2 | 緑 | 0 | 1 | 0 | 1秒 |
| 3 | 青 | 0 | 0 | 1 | 1秒 |
| 4 | 白 | 1 | 1 | 1 | 1秒 |
| 5 | 黄 | 1 | 1 | 0 | 1秒 |
| 6 | シアン | 0 | 1 | 1 | 1秒 |
| 7 | マゼンタ | 1 | 0 | 1 | 1秒 |
| 8 | 消灯 | 0 | 0 | 0 | 1秒 |

**入力**: 
- `pvParameter`: タスクパラメータ（未使用）

**出力**: なし（無限ループで動作）

**タスク仕様**:
- タスク名: "led_blink_task"
- スタックサイズ: 2048バイト
- 優先度: 5
- 実行モデル: 無限ループ

---

## 4. 定数定義

### 4.1 GPIO定義

```c
#define LED_RED_GPIO    GPIO_NUM_4   // 赤色LED GPIO番号
#define LED_GREEN_GPIO  GPIO_NUM_5   // 緑色LED GPIO番号
#define LED_BLUE_GPIO   GPIO_NUM_6   // 青色LED GPIO番号
```

### 4.2 タイミング定義

```c
#define BLINK_INTERVAL_MS 1000  // LED点滅間隔（ミリ秒）
```

---

## 5. 動作フロー

### 5.1 起動シーケンス

```
起動
  ↓
app_main()実行
  ↓
LED初期化（led_init()）
  ├─ GPIO設定
  ├─ 出力モード設定
  └─ 全LED OFF
  ↓
LED点滅タスク作成
  ├─ タスク関数: led_blink_task
  ├─ スタック: 2048バイト
  └─ 優先度: 5
  ↓
タスクスケジューラ実行
  ↓
LED点滅ループ（無限）
```

### 5.2 LED点滅タスクフロー

```
タスク開始
  ↓
パターン初期化（pattern = 0）
  ↓
  ┌─────────────┐
  │ ループ開始   │
  └─────────────┘
  ↓
パターンに応じた色設定
  ├─ case 0: 赤色点灯
  ├─ case 1: 緑色点灯
  ├─ case 2: 青色点灯
  ├─ case 3: 白色点灯
  ├─ case 4: 黄色点灯
  ├─ case 5: シアン点灯
  ├─ case 6: マゼンタ点灯
  └─ case 7: 消灯
  ↓
ログ出力
  ↓
パターン更新（pattern = (pattern + 1) % 8）
  ↓
待機（1000ms）
  ↓
  └─→ループ継続
```

---

## 6. メモリ使用量

### 6.1 スタックメモリ

| タスク名 | スタックサイズ | 用途 |
|---------|--------------|------|
| led_blink_task | 2048バイト | LED点滅制御 |
| idle task | 1024バイト | システムアイドル |

### 6.2 推定メモリ使用量

- **プログラムメモリ**: 約50KB（ESP-IDF基本ライブラリ含む）
- **動的メモリ**: 約10KB（FreeRTOS含む）

---

## 7. 性能仕様

### 7.1 タイミング仕様

| 項目 | 仕様値 | 備考 |
|-----|--------|------|
| LED切替間隔 | 1000ms ± 10ms | FreeRTOSタスク遅延精度依存 |
| GPIO切替速度 | < 1μs | ESP32 GPIO性能 |
| 起動時間 | < 3秒 | 電源ONからLED点灯開始まで |

### 7.2 電力仕様

| 動作モード | 消費電流 | 備考 |
|----------|---------|------|
| LED全消灯時 | 約30mA | マイコンのみ |
| LED全点灯時 | 約50mA | LED電流含む |

---

## 8. エラー処理

### 8.1 エラー検出

| エラー種別 | 検出方法 | 対処 |
|----------|---------|------|
| GPIO設定エラー | gpio_config()戻り値 | ESP-IDFエラーハンドラ |
| タスク生成失敗 | xTaskCreate()戻り値 | ログ出力 |

### 8.2 ログレベル

プログラムは以下のログレベルでメッセージを出力します：

- **INFO**: 正常動作時の情報（初期化完了、LED状態変更など）
- **WARN**: 警告（未使用）
- **ERROR**: エラー発生時（未使用）

---

## 9. テスト仕様

### 9.1 単体テスト項目

| テストID | テスト項目 | 確認内容 | 判定基準 |
|---------|-----------|---------|---------|
| T001 | LED初期化 | GPIO設定の正常完了 | エラーログなし |
| T002 | 赤色LED点灯 | 赤色LEDのみ点灯 | 目視確認 |
| T003 | 緑色LED点灯 | 緑色LEDのみ点灯 | 目視確認 |
| T004 | 青色LED点灯 | 青色LEDのみ点灯 | 目視確認 |
| T005 | 白色LED点灯 | 全色LED点灯 | 目視確認 |
| T006 | LED消灯 | 全色LED消灯 | 目視確認 |
| T007 | 点滅間隔 | 1秒間隔での切替 | ストップウォッチ測定 |
| T008 | パターン遷移 | 8パターンの順次実行 | 目視確認 |

### 9.2 結合テスト項目

| テストID | テスト項目 | 確認内容 | 判定基準 |
|---------|-----------|---------|---------|
| I001 | 連続動作 | 1時間の連続点滅 | 異常なし |
| I002 | 再起動 | リセット後の正常動作 | 正常起動 |

---

## 10. カスタマイズ方法

### 10.1 点滅間隔の変更

`BLINK_INTERVAL_MS`定数を変更：
```c
#define BLINK_INTERVAL_MS 500  // 0.5秒間隔に変更
```

### 10.2 GPIO番号の変更

LED GPIO定義を変更：
```c
#define LED_RED_GPIO    GPIO_NUM_XX  // 任意のGPIO番号
```

### 10.3 点滅パターンの変更

`led_blink_task()`関数内のswitch文を編集：
```c
case 0:
    led_set_rgb(1, 1, 0);  // 黄色から開始
    break;
```

---

## 11. 制約事項

### 11.1 ハードウェア制約
- GPIO4, 5, 6は他の機能と競合しないこと
- LED駆動電流は最大20mA以下

### 11.2 ソフトウェア制約
- ESP-IDF v4.4以降が必要
- FreeRTOSが有効であること
- GPIO制御ライブラリが利用可能であること

---

## 12. 参考資料

### 12.1 関連ドキュメント
- ESP-IDF Programming Guide: https://docs.espressif.com/projects/esp-idf/
- AWS IoT EduKit Documentation: https://edukit.workshop.aws/

### 12.2 使用ライブラリ
- FreeRTOS: リアルタイムOSカーネル
- ESP-IDF GPIO Driver: GPIO制御ドライバ
- ESP-IDF Log Library: ログ出力ライブラリ

---

## 13. 改訂履歴

| 版数 | 日付 | 改訂内容 | 作成者 |
|-----|------|---------|--------|
| 1.0 | 2025/12/27 | 初版作成 | GitHub Copilot |

---

## 14. 承認

| 役割 | 氏名 | 日付 | 署名 |
|-----|------|------|------|
| 作成者 | - | 2025/12/27 | - |
| 確認者 | - | - | - |
| 承認者 | - | - | - |

---

**文書管理番号**: SPEC-AWS-EDUKIT-LED-001  
**機密区分**: 公開  
**版数**: 1.0

